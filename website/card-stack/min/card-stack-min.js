function htmlEncode(t){return $("<div/>").text(t).html()}function htmlDecode(t){return $("<div/>").html(t).text()}function stripHash(t){return t.replace("#","")}function stripAtDetail(t){return stringArr=t.split(" at "),stringArr[0]=stringArr[0].replace("Last ",""),stringArr[0]}function slideLeft(t){var e=$(t).parent().parent();e.find(".cardBack-1").addClass("slideOutLeft"),e.find(".cardBack-2").addClass("slideInLeft")}function slideRight(t){var e=$(t).parent().parent().parent();e.find(".cardBack-1").removeClass("slideOutLeft"),e.find(".cardBack-2").removeClass("slideInLeft")}function getHighlightDates(t){return t.startRange===t.endRange?t.startRange:void 0}$(".prevButton").on("mousedown",function(){$(this).removeClass("button-shadow")}),$(".prevButton").on("mouseup",function(){$(this).addClass("button-shadow")}),$(".nextButton").on("mousedown",function(){$(this).removeClass("button-shadow")}),$(".nextButton").on("mouseup",function(){$(this).addClass("button-shadow")}),$(document).keydown(function(t){var e=t.keyCode||t.which,a={left:37,up:38,right:39,down:40};switch(e){case a.left:$(".prevButton").trigger("click");break;case a.right:$(".nextButton").trigger("click");break;default:return}t.preventDefault()}),moment.locale("en",{calendar:{lastDay:"[Yesterday at] LT",sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",lastWeek:"dddd [at] LT",nextWeek:"[next] dddd [at] LT",sameElse:"ll"}});var deferred=$.Deferred(),offline=!1;if(offline){var data=[{id:"5584077dedd7cc047e86fe34",type:"top10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["music"],actionTags:["listen"],position:0,properties:{sum:{"album-name":{"The Inevitable End":{__count__:10}}}},generatedDate:"2015-06-19T12:13:49.256Z",chart:"/v1/users/ed/rollups/day/music/listen/sum.album-name..__count__/.json"},{id:"5584077dedd7cc047e86fe30",type:"top10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["music"],actionTags:["listen"],position:2,properties:{sum:{"artist-name":{"Daft Punk":{__count__:1}}}},generatedDate:"2015-06-19T12:13:49.017Z",chart:"/v1/users/ed/rollups/day/music/listen/sum.album-name..__count__/.json"},{id:"5584077dedd7cc047e86fe35",type:"bottom10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","control","software","source"],actionTags:["github","push"],position:28,properties:{sum:{commits:5}},generatedDate:"2015-06-19T12:13:49.301Z",chart:"/v1/users/ed/rollups/day/computer,control,software,source/github,push/sum.commits/.json"},{id:"5584077dedd7cc047e86fe39",type:"top10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","control","software","source"],actionTags:["commit"],position:1,properties:{sum:{__count__:5}},generatedDate:"2015-06-19T12:13:49.626Z",chart:"/v1/users/ed/rollups/day/computer,control,software,source/github,push/sum.__count__/.json"},{id:"5584077dedd7cc047e86fe3a",type:"bottom10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","control","software","source"],actionTags:["github","push"],position:0,properties:{sum:{repo:{"1self/api":{__count__:1}}}},generatedDate:"2015-06-19T12:13:49.630Z",chart:"/v1/users/ed/rollups/day/computer,control,software,source/github,push/sum.repo.1self/api.__count__/.json"},{id:"5584077dedd7cc047e86fe32",type:"top10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","control","software","source"],actionTags:["github","push"],position:0,properties:{sum:{repo:{"1self/api":{commits:1}}}},generatedDate:"2015-06-19T12:13:49.036Z",chart:"/v1/users/ed/rollups/day/computer,control,software,source/github,push/sum.repo.1self/api.commits/.json"},{id:"5584077dedd7cc047e86fe37",type:"bottom10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","git","github","software","source control"],actionTags:["commit"],position:8,properties:{sum:{__count__:5}},generatedDate:"2015-06-19T12:13:49.528Z",chart:"/v1/users/ed/rollups/day/computer,git,github,software,source control/commit/sum.__count__/.json"},{id:"5584077dedd7cc047e86fe3c",type:"bottom10",thumbnailMedia:"chart.html",startRange:"2015-06-25",endRange:"2015-06-25",objectTags:["computer","git","github","software","source control"],actionTags:["commit"],position:6,properties:{sum:{"author-email":{"ed^sykes@gmail^com":{__count__:5}}}},generatedDate:"2015-06-19T12:13:49.862Z",chart:"/v1/users/ed/rollups/day/computer,git,github,software,source control/commit/sum.author-email.ed^sykes@gmail^com.__count__/.json"}];deferred.resolve(data)}else{var username=getQSParam().user,minStdDev=getQSParam().minStdDev,maxStdDev=getQSParam().maxStdDev,sort_by_date=function(t,e){return new Date(e.cardDate).getTime()-new Date(t.cardDate).getTime()};console.log("minStdDev",minStdDev),username||(username="ed");var url="https://api-staging.1self.co/v1/users/";url+=username+"/cards",url+=minStdDev?"?minStdDev="+minStdDev:"?minStdDev=2",url+=maxStdDev?"&maxStdDev="+maxStdDev:"",console.log(url),$.getJSON(url,function(){console.log("accessed api for cards")}).done(function(t){t.sort(sort_by_date),console.log("card data",t),window.cardData=t,deferred.resolve(t)}).fail(function(t){console.log("error getting cards",t)})}$(function(){function t(t){var e=$(t),a=e.attr("id"),o=e.parent();e.detach(),o.append(t)}function e(t,e){var a=t.length-1,o=t.length,r=null;if(e!==a){r=t[e];for(var n=e;o>n;++n)t[n]=t[n+1];t[a]=r}}function a(t,e){$(".stack li").removeClass(e),void 0!==t&&$(t).addClass(e)}var o,r=function(t){var e=["#dd2649","#00a2d4","#e93d31","#f2ae1c","#61b346","#cf4b9a","#367ec0","#00ad87"];return e[t%e.length]},n=function(t,e,a){var o={};o.eventCategory="card-stack",o.eventAction=t,o.eventLabel=e,o.eventValue=a,console.log("gaObj",o),ga("send","event",o)},s=function(t,e){var a,o=moment();return t===e?(t=moment(t),a=t.calendar()):(t=moment(t),e=moment(e),a=t.format("lll")+" - "+e.format("lll")),a},i=function(t){var e="";for(var a in t)e+=t[a]+" ";return e.trim()};String.prototype.supplant=function(t){return this.replace(/\{\{([^{}]*)\}\}/g,function(e,a){var o=t[a];return"string"==typeof o||"number"==typeof o?o:e})};var c=function(t,e){var a="";return a="top10"===e?"most":"fewest",t>0&&(a=ordinal_suffix_of(t+1,!0)+" "+a),a},d=function(t){var e=[];for(var a in t){var o;o="push"===t[a]?"es":"s",e.push(t[a]+o)}return e},l=function(t){var e=[];for(var a in t){var o;o="commit"===t[a]?"ted":"s",e.push(t[a]+o)}return e},u=function(t){return t.replace(/\^/g,".").replace(/-/g," ")},p=function(t){return"artist-name"===t?"":"album-name"===t?"tracks from the album":t.indexOf("percent")>=0?t.replace("percent","").trim():t.indexOf("duration")>=0?t.replace("duration","").trim():t},h=function(t){return"computer desktop"===t?"computer use":t},m=function(t){for(var e=t.toPrecision(3)+"";e.indexOf(".")>=0&&("0"===e.charAt(e.length-1)||"."===e.charAt(e.length-1));)e=e.substring(0,e.length-1);return e},g=function(t){for(var e="",a=Object.keys(t)[0],o,r=0,n={},s=!1,i=!1;a&&"__count__"!==a;){var c=u(p(a));t=t[a],o=a,a.indexOf("duration")>=0?s=!0:a.indexOf("percent")>=0&&(i=!0),a="object"==typeof t?Object.keys(t)[0]:null,""!==c&&(e+=c,a&&"__count__"!==a&&(e+=": ")),r++}return n.propertiesText=e,"__count__"===a?n.value=t[a]:n.value=t,s?n.value<60?n.value=m(n.value)+" seconds":n.value=moment.duration(n.value,"seconds").humanize():i&&(n.value=m(n.value)+"%"),n},v=function(t,e){if(!t.cardText){var a="";if("top10"===t.type||"bottom10"===t.type){var o="<b>{{eventDate}}</b><br>{{comparitor}} {{action_pl}} in {{eventPeriod}} {{comparisonPeriod}}",r="<b>{{eventDate}}</b><br>{{comparitor}} {{action_pp}} {{property}} in {{eventPeriod}} {{comparisonPeriod}}",n="<b>{{eventDate}}</b><br>{{comparitor}} {{objects}} {{action_pl}} in {{eventPeriod}} {{comparisonPeriod}}",u="<b>{{eventDate}}</b><br>{{comparitor}} {{action_pl}} to {{property}} in {{eventPeriod}} {{comparisonPeriod}}",p="<b>{{eventDate}}</b><br>{{comparitor}} {{objects}} {{property}} in {{eventPeriod}} {{comparisonPeriod}}",m="<b>{{eventDate}}</b><br>{{value}} {{action_pl}} to {{property}}<br>Your {{comparitor}} in {{eventPeriod}} {{comparisonPeriod}}",v="<b>{{eventDate}}</b><br>{{value}} {{property}} {{objects}}<br>Your {{comparitor}} in {{eventPeriod}} {{comparisonPeriod}}",f={eventDate:stripAtDetail(s(t.startRange,t.endRange)),comparitor:c(t.position,t.type),eventPeriod:"a day",comparisonPeriod:"",colour:e},b=g(t.properties.sum);"commit"===t.actionTags[0]||"push"===t.actionTags[1]?t.properties.sum.__count__?(f.action_pl=i(d(t.actionTags)),a=o.supplant(f)):(f.action_pp=i(l(t.actionTags)),f.property=b.propertiesText,a=r.supplant(f)):"listen"===t.actionTags[0]?t.properties.sum.__count__?(f.action_pl=i(d(t.actionTags)),f.objects=i(t.objectTags),a=n.supplant(f)):(f.action_pl=i(d(t.actionTags)),f.property=b.propertiesText,f.value=b.value,a=m.supplant(f)):"use"===t.actionTags[0]&&(f.property=b.propertiesText,f.objects=h(i(t.objectTags)),f.value=b.value,a=v.supplant(f)),a=a.supplant(f)}""===a&&(a="Couldn't create friendly message"),t.cardText=a}},f=[,'  <div class="avatar-button standard-shadow">','    <!--div class="icon-button"><i class="fa fa-share-alt fa-2x"></i></div-->',"  </div>",'  <div class="share-button standard-shadow" style="background-color: {{colour}};">','    <div class="icon-button"><i class="fa fa-share-alt fa-2x"></i></div>',"  </div>",'  <div class="flip-toggle standard-shadow" style="background-color: {{colour}};">','    <div class="icon-button"><i class="fa fa-angle-double-{{action}} fa-2x"></i></div>','    <!--div class="icon-button icon-{{action}}"><img src="img/{{action}}-icon.png" /></div-->',"  </div>"].join(""),b=[,'<div class="cardBack-1">','  <div class="cardHeader" style="background-color: {{colour}};"><p>{{headerText}}</p></div>','    <div class="cardBackMain">','      <div class="cardBackTitle" style="border-bottom-color:{{colour}}"><p>{{chartTitleText}}</p></div>','      <div class="cardBackMedia">','        <!--iframe class="mainChartFrame" src="{{mainChartSrc}}" scrolling="no"></iframe-->',"      </div>","    </div>",'    <!--div class="cardBackAction" onclick="slideLeft(this)"><div class="actionText">Explore &gt;</div></div-->',"</div>",'<!--div class="cardBack-2">','  <div class="cardHeader" style="background-color: {{colour}};"><p class="backButton" onclick="slideRight(this)">{{headerText2}}</p></div>','  <div class="cardBackMain">Next bit of info goes here</div>',"</div-->","{{shareContainer}}"].join(""),T=[,'<div class="share-container {{shareContainerClasses}} hide" style="background-color: {{colour}};">','  <div class="social-share-button standard-shadow"><div id="shareToTwitter" class="innerButton">Share to Twitter</div></div>','  <div class="social-share-button standard-shadow"><div id="shareToFacebook" class="innerButton">Share to Facebook</div></div>','  <div class="social-share-button standard-shadow"><div id="shareToLink" class="innerButton">Get shareable link</div></div>',"</div>"].join(""),w=function(t,e){var a=moment(t.cardDate);t.colourIndex=e;var o=r(e),n={headerText:"",cardNavText:"",colour:o,colourIndex:e},s='<input id="hidCard_{{id}}" class="cardData" type="hidden" value="{{inputValue}}" />';if(s+='<div class="cardContainer cardContainer-front">{{cardFrontContent}}</div>',s+='<div class="cardContainer cardContainer-back">',s+="  {{cardBackContent}}",s+="{{cardNav}}</div>",s=s.supplant({id:t.id,inputValue:encodeURIComponent(JSON.stringify(t)),cardNav:f.supplant({colour:o,action:"left"})}),"date"===t.type){var i=stripAtDetail(a.calendar());s=s.supplant({cardFrontContent:'<div class="cardFullText" style="background-color: {{colour}};"><p>{{dateNow}}</p></div>'.supplant({dateNow:i,colour:o})})}else if("top10"===t.type||"bottom10"===t.type){var d;d="use"===t.actionTags[0]?"img/rescuetimeicon.svg":"listen"===t.actionTags[0]?"img/lastfm.svg":"img/githubicon.svg",v(t,o);var l="top10"===t.type?"Top":"Bottom";l+=" 10: "+c(t.position,t.type)+" of "+t.outOf;var u=[,'<div class="cardHeader" style="background-color: {{colour}};">',"  <p>{{headerText}}</p>","</div>",'<div class="cardContentContainer">','  <div class="cardMedia" style="border-bottom-color: {{colour}};"></div>','  <div class="cardText">','    <div class="glance-row">','      <div class="glance-blob-cell"><div class="glance-blob glance-blob-left" style="background-color:{{colour}};border-color:{{colour}}"><p>{{position}}</p></div></div><div class="glance-blob-cell"><div class="glance-blob glance-blob-right" style="background-image:url({{dataSourceIconUrl}});border-color:{{colour}}"></div></div>',"    </div>",'    <div class="main-text-row"><p>{{data}}</p></div>',"  </div>","</div>","{{shareContainer}}",'<div class="cardNav" style="background-color: {{colour}};">',"  <p>{{cardNavText}}</p>","  {{flipButton}}","</div>"].join("");s=s.supplant({cardFrontContent:u.supplant({data:t.cardText||"undefined",flipButton:f.supplant({colour:o,action:"right"}),cardNavText:"",colour:o,headerText:l,shareContainer:T.supplant({colour:o,shareContainerClasses:"share-container-front"}),dataSourceIconUrl:d,position:ordinal_suffix_of(t.position+1,!0)}),cardBackContent:b.supplant({colour:o,headerText:l,headerText2:"&lt; back",chartTitleText:t.cardText,shareContainer:T.supplant({colour:o,shareContainerClasses:"share-container-back"})})})}return s},_=function(t){if(t){var e=$(t).find(".cardData");if(e=decodeURIComponent(e.val()),e=JSON.parse(e),e.thumbnailMedia){var a=$(t).find(".cardMedia");a.empty();var o='<iframe class="thumbnailFrame" src="'+e.thumbnailMedia;o+="?lineColour="+stripHash(r(e.colourIndex)),o+="&highlightCondition="+e.type,o+="&highlightDates="+getHighlightDates(e),o+="&doTransitions=true",o+="&dataSrc="+encodeURIComponent(e.chart)+'" ',o+='scrolling="no"></iframe>',o+='<div class="clickable-overlay"></div>',a.append(o)}}},k=function(t){console.log("rendering main media");var e=$(t).find(".cardData");if(e=decodeURIComponent(e.val()),e=JSON.parse(e),e.thumbnailMedia){var a=$(t).find(".cardBackMedia");a.empty();var o='<iframe class="mainChartFrame" src="'+e.thumbnailMedia;o+="?lineColour="+stripHash(r(e.colourIndex)),o+="&highlightCondition="+e.type,o+="&highlightDates="+getHighlightDates(e),o+="&vaxis=true&haxis=true",o+="&displayTooltips=true",o+="&doTransitions=false",o+="&dataSrc="+e.chart+'" ',o+='scrolling="no"></iframe>',a.append(o)}},x=[],C=null,y=0,D,I=function(t,e,a,o){var n=document.createElement("li");n.innerHTML=w(e,a);var s=$(n).find(".cardContainer");s.css({"border-color":r(a)}),$(n).attr("id","card_"+y),$(n).attr("cardId",e.id),$(n).attr("cardIndex",a),$(n).addClass("mainPile"),$(".stack").append(n),t.createCard(n),o&&_(n),y++},O=function(t){var o=10,r=0;deferred.done(function(s){D=s,o>s.length&&(o=s.length);for(var i=o+r-1;i>=r;i--)I(t,s[i],i,i===r);a($(".stack li:last")[0],"topOfMain"),C=$(".stack li");var c=$(".stack");c.on("mouseup","li",function(t){var o="#"+this.id,r=x.indexOf(o);r>-1&&(e(x,r),a($(o),"topOfDiscard"))}),c.on("mousedown",".flip-toggle",function(t){$(".flip-toggle").removeClass("standard-shadow")}),c.on("mouseup",".flip-toggle",function(t){$(".flip-toggle").addClass("standard-shadow")}),c.on("mouseup",".clickable-overlay, .flip-toggle",function(t){var e=$(this).parents(".cardContainer"),a=$(this).parents("li");e.hasClass("flip")?(n("flipped-to-front-"+a.attr("cardIndex"),a.attr("cardId"),a.attr("cardIndex")),$("#viewport").removeAttr("style"),$(".body").removeAttr("style")):(k(a),n("flipped-to-back-"+a.attr("cardIndex"),a.attr("cardId"),a.attr("cardIndex")),$("#viewport").css({width:"100%",height:"100%"}),$(".body").css("padding","0px")),e.toggleClass("flip"),e.siblings().toggleClass("flip")}),c.on("mousedown",".share-button",function(t){$(".share-button").removeClass("standard-shadow")}),c.on("mouseup",".share-button",function(t){$(".share-button").addClass("standard-shadow");var e=$(this).parents(".cardContainer"),a=$(this).parents("li"),o=e.find(".share-container").hasClass("hide")?"open":"close";o+="-share-pane-",o+=e.hasClass("flip")?"back":"front",o+="-"+a.attr("cardIndex"),n(o,a.attr("cardId"),a.attr("cardIndex")),e.find(".share-container").toggleClass("hide")}),c.on("mousedown","#shareToTwitter",function(t){$("#shareToTwitter").parents(".social-share-button").removeClass("standard-shadow")}),c.on("mouseup","#shareToTwitter",function(t){$("#shareToTwitter").parents(".social-share-button").addClass("standard-shadow");var e=$(this).parents(".cardContainer"),a=$(this).parents("li"),o="share-to-twitter-";o+=e.hasClass("flip")?"back":"front",o+="-"+a.attr("cardIndex"),n(o,a.attr("cardId"),a.attr("cardIndex"))}),c.on("mousedown","#shareToFacebook",function(t){console.log($("#shareToFacebook").parent().attr("class")),$("#shareToFacebook").parent("div").toggleClass("standard-shadow"),console.log($("#shareToFacebook").parent().attr("class"))}),c.on("mouseup","#shareToFacebook",function(t){$("#shareToFacebook").parent("div").addClass("standard-shadow");var e=$(this).parents(".cardContainer"),a=$(this).parents("li"),o="share-to-facebook-";o+=e.hasClass("flip")?"back":"front",o+="-"+a.attr("cardIndex"),n(o,a.attr("cardId"),a.attr("cardIndex"))}),c.on("mousedown","#shareToLink",function(t){$("#shareToLink").parents(".social-share-button").removeClass("standard-shadow")}),c.on("mouseup","#shareToLink",function(t){$("#shareToLink").parents(".social-share-button").addClass("standard-shadow");var e=$(this).parents(".cardContainer"),a=$(this).parents("li"),o="share-to-link-";o+=e.hasClass("flip")?"back":"front",o+="-"+a.attr("cardIndex"),n(o,a.attr("cardId"),a.attr("cardIndex"))}),$(".bottom-of-stack-container h1").text("All done").css({"font-size":"3em",margin:"0.67em 0"}),$(".bottom-of-stack-container h1").after('<i class="fa fa-thumbs-o-up fa-4x"></i>'),$(".bottom-of-stack-container p").text("Come back for more cards later"),$(".bottom-of-stack-container .loading").remove()})},j={throwOutConfidence:function(t,e){return Math.min(Math.abs(t+180)/e.offsetWidth,1)}};o=gajus.Swing.Stack(j),o.throwInLast=function(){var e=$(".stack .topOfDiscard")[0];if(e){t(e);var a="#"+e.id,r=x.indexOf(a),s=o.getCard(e);s.throwIn(e.thrownX,e.thrownY),n("button-thrown-in-"+e.getAttribute("cardIndex"),e.getAttribute("cardId"),e.getAttribute("cardIndex"))}},o.throwOutNext=function(){var e=$(".stack .topOfMain")[0];if(e){t(e);var a=o.getCard(e);e.thrownY=getRandomInt(-100,100),e.thrownX=1,a.throwOut(e.thrownX,e.thrownY),n("button-thrown-out-"+e.getAttribute("cardIndex"),e.getAttribute("cardId"),e.getAttribute("cardIndex"))}},window.stack=o,O(o),o.on("throwout",function(t){console.log(t.throwOutConfidence),a($(".stack .topOfMain")[0],"topOfMain"),a(t.target,"topOfDiscard"),$(t.target).addClass("discardPile"),$(t.target).removeClass("mainPile"),x.push("#"+t.target.id),t.target.thrownX=1,t.target.thrownY=78;var e=x.length;a(C[C.length-1-e],"topOfMain"),_(C[C.length-1-e]),t.target.classList.remove("in-deck"),console.log("thrown out",t.target.id,x),n("thrown-out-"+t.target.getAttribute("cardIndex"),t.target.getAttribute("cardId"),t.target.getAttribute("cardIndex")),$(".topOfDiscard").delay(1e3).fadeOut(1e3,function(){})}),o.on("throwin",function(t){x.pop();var e=$(x[x.length-1])[0];a(t.target,"topOfMain"),a(e,"topOfDiscard"),$(t.target).show(),$(t.target).addClass("mainPile"),$(t.target).removeClass("discardPile"),t.target.classList.add("in-deck"),console.log("thrown in",t.target.id,x),n("thrown-in-"+t.target.getAttribute("cardIndex"),t.target.getAttribute("cardId"),t.target.getAttribute("cardIndex"))})});